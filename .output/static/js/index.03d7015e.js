"use strict";(self.webpackChunkvoice_bot_fe=self.webpackChunkvoice_bot_fe||[]).push([["980"],{66203:function(e,n,t){t.d(n,{Z:()=>T});var r=t("11527"),o=t("24502"),a=t("79190"),s=t("60387");t("2192");var i=t("58405"),c={PROTOCOL_VERSION:1,DEFAULT_HEADER_SIZE:1,HEADER_BITS:4,PAYLOAD_LENGTH_BYTES:4,CLIENT_FULL_REQUEST:1,CLIENT_AUDIO_ONLY_REQUEST:2,SERVER_FULL_RESPONSE:9,SERVER_AUDIO_ONLY_RESPONSE:11,NO_SEQUENCE:0,JSON:1,NO_COMPRESSION:0},E=e=>{var n=u(c.CLIENT_AUDIO_ONLY_REQUEST);return n.setUint32(4,e.size,!1),new Blob([n,e])},u=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:c.CLIENT_FULL_REQUEST,n=new DataView(new ArrayBuffer(8));return n.setUint8(0,c.PROTOCOL_VERSION<<4|c.DEFAULT_HEADER_SIZE),n.setUint8(1,e<<4|c.NO_SEQUENCE),n.setUint8(2,c.JSON<<4|c.NO_COMPRESSION),n.setUint8(3,0),n},l=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:c.CLIENT_AUDIO_ONLY_REQUEST,n=new DataView(new ArrayBuffer(8));return n.setUint8(0,c.PROTOCOL_VERSION<<4|c.DEFAULT_HEADER_SIZE),n.setUint8(1,e<<4||c.NO_SEQUENCE),n.setUint8(2,c.JSON<<4|c.NO_COMPRESSION),n.setUint8(3,0),n},_=e=>{var n=new DataView(e),t=15&n.getUint8(0),r=S(n.getUint8(1)),o=e.slice(t*c.HEADER_BITS),a=new DataView(o).getUint32(0),s=o.slice(c.PAYLOAD_LENGTH_BYTES);return r===c.SERVER_AUDIO_ONLY_RESPONSE?{messageType:c.SERVER_AUDIO_ONLY_RESPONSE,payload:o.slice(c.PAYLOAD_LENGTH_BYTES,c.PAYLOAD_LENGTH_BYTES+a)}:{messageType:c.SERVER_FULL_RESPONSE,payload:JSON.parse(new TextDecoder().decode(s))}},d=e=>{var{event:n,payload:t}=e;if(console.log("handleMessage",n,t),!!n)switch(n){case"BotReady":console.log("BotReady",t);break;case"BotUpdateConfig":console.log("BotUpdateConfig",t);break;case"SentenceRecognized":console.log("SentenceRecognized",t);break;case"TTSSentenceStart":console.log("TTSSentenceStart",t);break;case"TTSDone":console.log("TTSDone",t);break;case"BotError":console.log("BotError",t);break;default:console.log("Unknown event",n,t)}},S=e=>e>>4&15,O=t("50959"),R=t("86228"),f=t.n(R);class N{connect(){var e=this;return(0,s._)(function*(){return new Promise((n,t)=>{var r=new WebSocket(e.ws_url);r.onopen=()=>{e.ws=r,n(r)},r.onerror=n=>{t(n),e.onError(n)},r.onmessage=n=>e.onMessage(n)})})()}sendMessage(e){var n;null===(n=this.ws)||void 0===n||n.send(function(e){if(e.payload){var n=l(c.CLIENT_FULL_REQUEST),t=JSON.stringify(e.payload),r=new TextEncoder().encode(t).length;return n.setUint32(4,r,!1),new Blob([n,t])}var o=l(),a=e.data||new Blob;return o.setUint32(4,a.size,!1),new Blob([o,a])}(e))}onMessage(e){try{e.data.arrayBuffer().then(e=>{var n=_(e);console.log("##resp",n),n.messageType===c.SERVER_FULL_RESPONSE&&d(n.payload),n.messageType===c.SERVER_AUDIO_ONLY_RESPONSE&&this.handleAudioOnlyResponse(n.payload)})}catch(e){this.onError(e)}}handleAudioOnlyResponse(e){var n=this;return(0,s._)(function*(){var t=yield n.audioCtx.decodeAudioData(new Uint8Array(e).buffer),r=n.audioCtx.createBufferSource();r.buffer=t,r.connect(n.audioCtx.destination),r.start(0)})()}onError(e){console.error(e),this.dispose()}dispose(){var e;null===(e=this.ws)||void 0===e||e.close()}constructor(e){this.ws_url=e.ws_url,this.audioCtx=new AudioContext}}let U=()=>{var e=(0,O.useRef)(),n=(0,O.useRef)(null),[t,o]=(0,O.useState)(""),a=(0,O.useRef)(),c=(0,O.useRef)(),u=(0,O.useCallback)((0,s._)(function*(){return new Promise((e,t)=>{navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{n.current=t,e(t)}):t(null)})}),[]),l=(0,O.useCallback)(()=>{var e=new N({ws_url:"ws://10.254.198.22:8888/api/voice/chat"});return c.current=e,e.connect()},[]),_=(0,O.useCallback)((0,s._)(function*(){try{var t=yield l();if(a.current=t,yield u(),!n.current)return;e.current=new(f())(n.current,{type:"audio",recorderType:R.StereoAudioRecorder,mimeType:"audio/wav",numberOfAudioChannels:1,desiredSampRate:16e3,disableLogs:!0,timeSlice:100,ondataavailable:e=>(0,s._)(function*(){var n=a.current,t=c.current;if(!!n&&!!t){var r=e.slice(44),o=E(r);n.readyState===n.OPEN&&t.sendMessage({event:"UserAudio",data:o})}})()}),e.current.startRecording()}catch(e){console.error(e)}}),[u,l]);return(0,r.jsxs)("div",{className:"root",children:[(0,r.jsx)(i.Z,{onClick:()=>{_()},children:"\u5F00\u59CB\u5BF9\u8BDD"}),(0,r.jsxs)("p",{children:["\u8BED\u97F3\u8BC6\u522B\u7ED3\u679C: ",t]})]})},T=()=>(0,r.jsx)(o.VK,{children:(0,r.jsx)(a.Z5,{children:(0,r.jsx)(a.AW,{path:"/",element:(0,r.jsx)(U,{})})})})},76023:function(e,n,t){t.d(n,{Z:function(){return r}});let r=(0,t(88434).mc)({})},28651:function(e,n,t){t(49802),t(8998),t(54215),t(78340),t(21467),t(14426),t(57055),t(94707),t(9647),t(63598),t(17308),t(45731),t(56954),t(26256),t(79897),t(64042),t(82015),t(50046),t(42874),t(93201),t(60259),t(58530),t(45614),t(98368),t(11136),t(68073),t(78116),t(77928),t(25761),t(97001),t(24663),t(31996),t(98035),t(36591),t(87158),t(34827),t(38647),t(31499),t(16684),t(9896),t(64626),t(97889),t(54182),t(56399),t(6136),t(78275),t(62689),t(24247),t(97708),t(36167),t(32151),t(5527),t(34165),t(90323),t(77878),t(61529),t(43473),t(95765),t(61792),t(27339),t(81705),t(17163),t(70991),t(77650),t(46015),t(92615),t(86377),t(52783),t(80153),t(92832),t(35529),t(56535),t(62357),t(10824),t(20851),t(85456),t(70381),t(1972),t(66633),t(61260),t(3088),t(10170),t(49210),t(59418),t(12807),t(20376),t(55413),t(48679),t(30778),t(27366),t(71915),t(33128),t(46524),t(60634),t(22676),t(48606),t(89651),t(37023),t(42718),t(18825),t(69898),t(15820),t(80678),t(97853),t(19974),t(92293),t(99904),t(15075),t(46319),t(69587),t(75734),t(51268),t(19090),t(70724),t(59873),t(85808),t(88062),t(43793),t(93051),t(48066),t(69066),t(41156),t(14734),t(66663),t(60545),t(87573),t(85209),t(39),t(19248),t(1059),t(36704),t(66376),t(91973),t(89287),t(82515),t(1509),t(45635),t(30224),t(79674),t(56293),t(65962),t(41390),t(83421),t(71847),t(83100),t(33826),t(4381),t(11177),t(86856),t(21901),t(59587),t(43217),t(51891),t(91143),t(77554),t(60775),t(650),t(67915),t(89183),t(63682),t(77586),t(28616),t(28822),t(11525),t(76633),t(85508),t(97249),t(65245),t(88211),t(22871),t(68983),t(34702),t(51012),t(42481),t(67781),t(14373),t(20377),t(96366),t(60642),t(9915),t(24949),t(72639),t(88717),t(57370),t(94602),t(7217),t(63157),t(8894),t(49839),t(19061),t(58234),t(33731),t(29745),t(22345),t(14787),t(25899),t(96098),t(18070),t(29869),t(28552),t(20563),t(70540),t(87120),t(90725),t(58882),t(48406),t(78159),t(72198),t(64377),t(37676),t(61551),t(46614),t(76201),t(67922),t(42367),t(97234),t(60868),t(88751),t(7713),t(21242),t(82102),t(90397),t(82835),t(95043),t(4830),t(23692),t(98081),t(48425),t(2068),t(39620),t(91593),t(72715),t(51034),t(14897),t(76490),t(89644),t(22225),t(51275),t(10302),t(72998),t(28881),t(74617),t(53950),t(34146),t(29704),t(33336),t(95945),t(35844),t(51064),t(22876),t(59845),t(4305),t(6635),t(80140),t(71219),t(33414),t(4936),t(16852),t(30112),t(54299),t(53280),t(27901),t(50034),t(6422),t(97804),t(20928),t(67751),t(27445),t(21829),t(35372),t(80744),t(3531),t(83583),t(36273),t(9570),t(41832),t(49162),t(70632),t(14511),t(47756),t(63694),t(11618),t(48383),t(29896),t(87638),t(70437),t(62841),t(19810),t(618),t(41305),t(61995),t(47471),t(42765),t(49460),t(86312),t(56777),t(40671),t(27178),t(80567),t(19530),t(2316),t(45322),t(86068),t(15591)},5256:function(){window.__assetPrefix__=""}},function(e){var n=function(n){return e(e.s=n)};e.O(0,["118","126","19","361","709"],function(){return n("5256"),n("28651"),n("8219")}),e.O()}]);